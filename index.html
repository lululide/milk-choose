<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆ‘å¸®ä½ é€‰æ‹©ï¼</title>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC",
        "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(180deg, #faf7f3, #f5efe9);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 24px 16px 40px;
      color: #333;
      /* ç§»åŠ¨ç«¯å­—ä½“æ¸²æŸ“ä¼˜åŒ– */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    @media (max-width: 480px) {
      body {
        padding: 16px 12px 32px;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 12px;
      }

      .wheel-wrapper {
        width: min(320px, 85vw);
        height: min(320px, 85vw);
      }

      canvas {
        width: 100%;
        height: 100%;
      }

      .spin-btn {
        padding: 12px 28px;
        font-size: 15px;
        margin-top: 20px;
      }

      .result {
        font-size: 16px;
        margin-top: 16px;
        text-align: center;
        padding: 0 16px;
      }

      .modal-content {
        padding: 20px;
        width: 95%;
        max-height: 85vh;
      }

      .item-row {
        flex-wrap: wrap;
      }

      .item-row input,
      .item-row input[type="text"]:last-of-type {
        min-width: 0;
        flex: 1 1 100%;
        margin-bottom: 8px;
      }

      .delete-btn {
        flex: 1 1 auto;
      }
    }

    h1 {
      font-size: 22px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
    }

    .tabs button {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(6px);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.25s ease;
      color: #555;
    }

    .tabs button.active {
      background: #333;
      color: #fff;
    }

    .wheel-wrapper {
      position: relative;
      width: 320px;
      height: 320px;
    }

    canvas {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
      transition: transform 3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .pointer {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 11px solid transparent;
      border-right: 11px solid transparent;
      /* å‘ä¸‹æŒ‡å‘è½¬ç›˜å†…ä¾§ï¼ˆæœå‘åœ†å¿ƒï¼‰- å¤–å±‚ç™½è‰²æè¾¹ */
      border-top: 18px solid #fff;
      z-index: 10;
    }

    .pointer::after {
      content: '';
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      /* å†…å±‚é»‘è‰²ç®­å¤´ï¼Œå‘ä¸‹æŒ‡å‘è½¬ç›˜ */
      border-top: 16px solid #333;
    }

    .spin-btn {
      margin-top: 26px;
      padding: 14px 36px;
      border-radius: 999px;
      border: none;
      background: #333;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .spin-btn:active {
      transform: scale(0.96);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .result {
      margin-top: 20px;
      font-size: 18px;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .result.show {
      opacity: 1;
    }

    .edit-btn {
      margin-top: 12px;
      padding: 8px 20px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: rgba(255, 255, 255, 0.9);
      color: #666;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .edit-btn:hover {
      background: #fff;
      border-color: #999;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .item-list {
      margin-bottom: 20px;
    }

    .item-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    .item-row input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .item-row select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      min-width: 120px;
    }

    .item-row input[type="text"]:last-of-type {
      min-width: 100px;
    }

    .delete-btn {
      padding: 8px 16px;
      background: #ff4444;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .add-btn {
      width: 100%;
      padding: 10px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .save-btn {
      width: 100%;
      padding: 12px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
    }
  </style>
</head>

<body>
  <h1 id="title">ä»Šå¤©å–å“ªæ¯å¥¶èŒ¶ï¼Ÿ</h1>

  <div class="tabs">
    <button id="tab-milk" class="active" onclick="switchWheel('milkTea')">
      å¥¶èŒ¶
    </button>
    <button id="tab-food" onclick="switchWheel('food')">
      åƒä»€ä¹ˆ
    </button>
  </div>

  <div class="wheel-wrapper">
    <div class="pointer"></div>
    <canvas id="wheel" width="320" height="320"></canvas>
  </div>

  <button class="spin-btn" onclick="spin()">å¼€å§‹è½¬ ğŸ¯</button>

  <div class="result" id="result"></div>

  <button class="edit-btn" onclick="openEditModal()">ç¼–è¾‘å†…å®¹ âœï¸</button>

  <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ç¼–è¾‘å†…å®¹</div>
        <button class="close-btn" onclick="closeEditModal()">Ã—</button>
      </div>
      <div id="editContent"></div>
      <button class="save-btn" onclick="saveItems()">ä¿å­˜</button>
    </div>
  </div>

  <script>
    /* ========= è½¬ç›˜é…ç½® ========= */
    /* 
     * åˆå§‹å†…å®¹é…ç½®ï¼š
     * 1. å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œä¿®æ”¹åˆå§‹çš„å¥¶èŒ¶å’Œé£Ÿç‰©é€‰é¡¹
     * 2. ä¿®æ”¹åï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ä¿å­˜è¿‡è‡ªå®šä¹‰å†…å®¹ï¼Œä¼šä½¿ç”¨è¿™é‡Œçš„åˆå§‹å€¼
     * 3. å¦‚æœç”¨æˆ·å·²ç»ä¿å­˜è¿‡è‡ªå®šä¹‰å†…å®¹ï¼ˆåœ¨localStorageä¸­ï¼‰ï¼Œä¼šä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„å†…å®¹
     * 4. è¦é‡ç½®ä¸ºåˆå§‹å€¼ï¼Œå¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼šlocalStorage.removeItem("wheelsData")
     */
    let wheels = {
      milkTea: {
        title: "ä»Šå¤©æƒ³å–ä»€ä¹ˆï¼Ÿ",
        items: [
          { name: "å†°æ·‡æ·‹çº¢èŒ¶", group: "ä¸€ç‚¹ç‚¹" },
          { name: "å¯å¯èŠ­è•¾", group: "ä¸€ç‚¹ç‚¹" },
          { name: "ç±³éº»è–¯", group: "ä¸€ç‚¹ç‚¹" },
          { name: "è‰è“å¥¶ç»¿", group: "ä¸€ç‚¹ç‚¹" },
          { name: "å¥¶ç»¿è£…èŠ’", group: "ä¸€ç‚¹ç‚¹" },
          { name: "èŒ‰è‰å¥¶ç»¿", group: "ä¸€ç‚¹ç‚¹" },
          { name: "æ¨æç”˜éœ²", group: "å–œèŒ¶" },
          { name: "è¶…çº§æ°´æœèŒ¶", group: "èŒ¶ç™¾é“" },
          { name: "è¥¿ç“œå•µå•µ", group: "èŒ¶ç™¾é“" },
          { name: "æŠ¹èŒ¶è„è„èŒ¶", group: "ä¹ä¹èŒ¶" },
          { name: "çŒ›çŠ¸å¯å¯", group: "ä¹ä¹èŒ¶" },
          { name: "å†°æ¤°è”æ", group: "ä¸‰å·æ¤°" },
          { name: "éœ¸ç‹èŒ¶å§¬", group: "default" },
        ],
      },
      food: {
        title: "ä»Šå¤©åƒä»€ä¹ˆï¼Ÿ",
        items: [
          { name: "æµ·åº•æéº»è¾£çƒ«", group: "æµ·åº•æ" },
          { name: "æ–°ç–†ç‚’ç±³ç²‰", group: "2" },
          { name: "éº»è¾£æ‹Œ", group: "3" },
          { name: "ä¸œåŒ—éº»è¾£çƒ«", group: "4" },
          { name: "è€ä¹¡é¸¡", group: "5" },
          { name: "ç´«èœåŒ…é¥­", group: "6" },
          { name: "ç±³æ‘æ‹Œé¥­", group: "7" },
          { name: "kfc", group: "8" },
          { name: "è½»é£Ÿæ²™æ‹‰", group: "9" },
          { name: "Tims", group: "10" },
          { name: "é‘«èŠ±æºªç‰›è‚‰ç²‰", group: "11" },
        ],
      },
    };

    // é¢œè‰²ç³»ç»Ÿï¼š
    // - group å¯ä»¥æ˜¯ä¸­æ–‡ï¼ˆä¾‹å¦‚åº—å"ä¸€ç‚¹ç‚¹/å–œèŒ¶/èŒ¶ç™¾é“"ï¼‰ï¼Œå®Œå…¨æ²¡é—®é¢˜
    // - æ¯ä¸ª group ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ª"ç¨³å®šçš„é¢œè‰²"ï¼ˆåŒåº—åŒè‰²ï¼‰ï¼Œå¹¶ä¿å­˜åˆ° localStorage
    // - é¢å¤–ä¿è¯ï¼šåœ¨åŒä¸€è½®è½¬ç›˜é‡Œï¼Œä¸åŒ group å°½é‡åˆ†é…ä¸ºä¸åŒé¢œè‰²ï¼ˆé¿å…çœ‹èµ·æ¥ä¸€ç‰‡åŒè‰²ï¼‰
    const DEFAULT_COLOR = "#E8E8E8";
    const GROUP_COLORS_KEY = "groupColors";
    const COLOR_VERSION_KEY = "colorVersion";
    const CURRENT_COLOR_VERSION = "v2"; // æ›´æ–°é¢œè‰²è¡¨æ—¶æ”¹è¿™ä¸ªç‰ˆæœ¬å·ï¼Œä¼šè‡ªåŠ¨æ¸…é™¤æ—§ç¼“å­˜

    // æŸ”å’Œä½†åŒºåˆ†åº¦é«˜çš„é¢œè‰²è¡¨ï¼ˆæ•°é‡è¶³å¤Ÿè¦†ç›–å¸¸è§åˆ†ç»„ï¼‰
    const PREDEFINED_COLORS = [
      "#FFD4D4", // ç²‰çº¢
      "#D4E4FF", // æµ…è“
      "#D4FFD4", // æµ…ç»¿
      "#FFE4D4", // æµ…æ©™
      "#E4D4FF", // æµ…ç´«
      "#FFFAD4", // æµ…é»„
      "#D4FFFA", // æµ…é’
      "#FFD4E4", // æµ…ç²‰
      "#E4FFD4", // æ·¡ç»¿
      "#FAD4FF", // æ·¡ç´«çº¢
      "#D4E4E4", // æ·¡é’ç°
      "#FFE4FA", // æ·¡ç²‰ç´«
      "#E4FAD4", // é»„ç»¿
      "#D4FAFF", // å¤©è“
      "#FAE4D4", // æè‰²
      "#E4D4E4", // æ·¡ç´«ç°
      "#D4FFE4", // è–„è·ç»¿
      "#FAFAD4", // ç±³é»„
      "#FFD4FA", // äº®ç²‰
      "#D4FAFA", // æ·¡é’ç»¿
    ];

    function loadGroupColors() {
      // æ£€æŸ¥é¢œè‰²ç‰ˆæœ¬ï¼Œå¦‚æœç‰ˆæœ¬ä¸åŒ¹é…å°±æ¸…ç©ºæ—§æ•°æ®
      const savedVersion = localStorage.getItem(COLOR_VERSION_KEY);
      if (savedVersion !== CURRENT_COLOR_VERSION) {
        localStorage.removeItem(GROUP_COLORS_KEY);
        localStorage.setItem(COLOR_VERSION_KEY, CURRENT_COLOR_VERSION);
        return {};
      }

      const saved = localStorage.getItem(GROUP_COLORS_KEY);
      if (!saved) return {};
      try {
        const parsed = JSON.parse(saved) || {};
        // è¿‡æ»¤æ‰æ— æ•ˆé¢œè‰²ï¼ˆä¾‹å¦‚æŸäº›æµè§ˆå™¨ä¸æ”¯æŒçš„ hsl å†™æ³•å¯¼è‡´çš„è„æ•°æ®ï¼‰
        const cleaned = {};
        for (const [k, v] of Object.entries(parsed)) {
          if (isValidCssColor(v)) cleaned[k] = v;
        }
        return cleaned;
      } catch (e) {
        return {};
      }
    }

    function saveGroupColors(map) {
      localStorage.setItem(GROUP_COLORS_KEY, JSON.stringify(map));
    }

    function isValidCssColor(color) {
      if (!color || typeof color !== "string") return false;
      const s = new Option().style;
      s.color = "";
      s.color = color;
      return s.color !== "";
    }

    // ç”¨äºç¨³å®šåˆ†é…çš„ hash
    function hashStringToInt(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = (hash * 31 + str.charCodeAt(i)) >>> 0;
      }
      return hash >>> 0;
    }

    function getGroupColor(groupRaw) {
      const group = (groupRaw || "").trim();
      if (!group) return DEFAULT_COLOR;

      const groupColors = loadGroupColors();
      if (groupColors[group]) return groupColors[group];

      const used = new Set(Object.values(groupColors));
      const base = hashStringToInt(group) % PREDEFINED_COLORS.length;
      let color = null;
      // çº¿æ€§æ¢æµ‹ï¼šå°½é‡é¿å…ä¸åŒ group è¢«åˆ†é…åˆ°åŒä¸€ä¸ªé¢œè‰²
      for (let i = 0; i < PREDEFINED_COLORS.length; i++) {
        const c = PREDEFINED_COLORS[(base + i) % PREDEFINED_COLORS.length];
        if (!used.has(c)) {
          color = c;
          break;
        }
      }
      // é¢œè‰²è¡¨ç”¨å°½çš„æç«¯æƒ…å†µï¼šå›é€€åˆ°å…¼å®¹å†™æ³•çš„ HSLï¼ˆé€—å·æ ¼å¼å…¼å®¹æ€§æœ€å¥½ï¼‰
      if (!color) {
        const hue = hashStringToInt(group) % 360;
        color = `hsl(${hue}, 60%, 88%)`;
      }

      groupColors[group] = color;
      saveGroupColors(groupColors);
      return color;
    }

    // ä»localStorageåŠ è½½æ•°æ®
    // æ³¨æ„ï¼šlocalStorageæ•°æ®ä¼šæŒä¹…åŒ–ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œå³ä½¿å…³é—­é¡µé¢æˆ–æµè§ˆå™¨ï¼Œæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±
    // æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨çš„æœ¬åœ°å­˜å‚¨ä¸­ï¼Œæ¯ä¸ªåŸŸåç‹¬ç«‹å­˜å‚¨
    // åœ¨æ‰‹æœºä¸Šä½¿ç”¨æ—¶ï¼Œæ•°æ®ä¼šä¿å­˜åœ¨æ‰‹æœºæµè§ˆå™¨çš„æœ¬åœ°å­˜å‚¨ä¸­ï¼Œå…³é—­åé‡æ–°æ‰“å¼€ä»ç„¶å­˜åœ¨
    function loadWheels() {
      const saved = localStorage.getItem("wheelsData");
      if (saved) {
        try {
          wheels = JSON.parse(saved);
        } catch (e) {
          console.error("åŠ è½½æ•°æ®å¤±è´¥", e);
        }
      }
    }

    // ä¿å­˜æ•°æ®åˆ°localStorage
    // ä¿å­˜çš„æ•°æ®ä¼šæŒä¹…åŒ–ï¼Œå³ä½¿å…³é—­æµè§ˆå™¨æˆ–é‡å¯æ‰‹æœºï¼Œæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±
    // åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µæ•°æ®æ‰ä¼šä¸¢å¤±ï¼š
    // 1. ç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨æ•°æ®
    // 2. ä½¿ç”¨æ— ç—•/éšç§æ¨¡å¼æµè§ˆ
    // 3. æµè§ˆå™¨å­˜å‚¨ç©ºé—´è¢«æ¸…ç†
    function saveWheels() {
      localStorage.setItem("wheelsData", JSON.stringify(wheels));
    }

    /* ========= çŠ¶æ€ ========= */
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const resultEl = document.getElementById("result");

    // ç§»åŠ¨ç«¯é«˜ DPI å±å¹•ä¼˜åŒ–ï¼šæ ¹æ® devicePixelRatio ç¼©æ”¾ Canvas
    function setupCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const displaySize = 320; // æ˜¾ç¤ºå°ºå¯¸
      const actualSize = displaySize * dpr; // å®é™…åƒç´ å°ºå¯¸
      
      // è®¾ç½® Canvas å®é™…åƒç´ å°ºå¯¸
      canvas.width = actualSize;
      canvas.height = actualSize;
      
      // è®¾ç½® Canvas æ˜¾ç¤ºå°ºå¯¸ï¼ˆCSSï¼‰
      canvas.style.width = displaySize + "px";
      canvas.style.height = displaySize + "px";
      
      // ç¼©æ”¾ç»˜åˆ¶ä¸Šä¸‹æ–‡ï¼Œè¿™æ ·æ‰€æœ‰ç»˜åˆ¶æ“ä½œéƒ½ä¼šè‡ªåŠ¨é€‚é…é«˜ DPI
      ctx.scale(dpr, dpr);
      
      // ä¼˜åŒ–æ–‡å­—æ¸²æŸ“
      ctx.textBaseline = "middle";
      ctx.textAlign = "left";
    }

    let currentType = "milkTea";
    let currentItems = [];
    let currentAngle = 0;
    let spinning = false;

    /* ========= ç»˜åˆ¶è½¬ç›˜ ========= */
    function drawWheel() {
      const displaySize = 320;
      ctx.clearRect(0, 0, displaySize, displaySize);
      const count = currentItems.length;
      if (count === 0) return;
      
      const step = (2 * Math.PI) / count;
      const centerX = displaySize / 2;
      const centerY = displaySize / 2;
      const radius = 150;

      // é‡è¦ï¼šè®©â€œç¬¬ 1 ä¸ªæ‰‡å½¢çš„ä¸­å¿ƒâ€å¯¹é½é¡¶éƒ¨æŒ‡é’ˆï¼ˆå¦åˆ™æŒ‡é’ˆå®¹æ˜“è½åœ¨æ‰‡å½¢è¾¹ç•Œä¸Šå¯¼è‡´æ˜¾ç¤ºç›¸é‚»é¡¹ï¼‰
      // æ‰‡å½¢ä¸­å¿ƒ = startAngle + step/2ï¼Œå› æ­¤è¿™é‡Œä»é¡¶éƒ¨ï¼ˆ-90åº¦ï¼‰å†å¾€å›å step/2
      const startAngle = -Math.PI / 2 - step / 2;

      currentItems.forEach((item, index) => {
        const color = getGroupColor(item.group);
        const angle1 = startAngle + step * index;
        const angle2 = angle1 + step;

        // ç»˜åˆ¶æ‰‡å½¢
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, angle1, angle2);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();

        // ç»˜åˆ¶åˆ†éš”çº¿ï¼ˆæ¯ä¸ªæ‰‡å½¢ä¹‹é—´éƒ½ç”»çº¿ï¼Œè®©åˆ†ç•Œæ›´æ¸…æ™°ï¼‰
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(
          centerX + Math.cos(angle2) * radius,
          centerY + Math.sin(angle2) * radius
        );
        ctx.strokeStyle = "rgba(0, 0, 0, 0.15)";
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // ç»˜åˆ¶æ–‡å­—
        ctx.save();
        ctx.translate(centerX, centerY);
        ctx.rotate(angle1 + step / 2);
        ctx.fillStyle = "#333";
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        
        // ä¼˜åŒ–å­—ä½“æ¸²æŸ“ï¼ˆç§»åŠ¨ç«¯æ¸…æ™°åº¦ï¼‰
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        
        // è®¡ç®—æ–‡å­—å¯ç”¨çš„æœ€å¤§å®½åº¦ï¼ˆæ‰‡å½¢åŠå¾„å‡å»å†…è¾¹è·ï¼‰
        const maxTextRadius = radius - 20; // ç•™20pxå†…è¾¹è·
        const textStartRadius = 50; // æ–‡å­—èµ·å§‹ä½ç½®ï¼ˆè·ç¦»ä¸­å¿ƒ50pxï¼‰
        const maxTextWidth = maxTextRadius - textStartRadius;
        
        // åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°ä»¥é€‚åº”æ–‡å­—é•¿åº¦ï¼ˆç§»åŠ¨ç«¯é€‚å½“å¢å¤§ï¼‰
        const baseFontSize = window.devicePixelRatio > 1 ? 15 : 14;
        let fontSize = baseFontSize;
        let displayText = item.name;
        // ä½¿ç”¨ç³»ç»Ÿå­—ä½“æ ˆï¼Œç¡®ä¿ç§»åŠ¨ç«¯æ¸…æ™°
        ctx.font = `${fontSize}px -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif`;
        let textWidth = ctx.measureText(displayText).width;
        
        // å¦‚æœæ–‡å­—å¤ªé•¿ï¼Œç¼©å°å­—ä½“
        if (textWidth > maxTextWidth) {
          fontSize = Math.floor((maxTextWidth / textWidth) * fontSize);
          fontSize = Math.max(11, fontSize); // æœ€å°11pxï¼ˆç§»åŠ¨ç«¯æ›´æ¸…æ™°ï¼‰
          ctx.font = `${fontSize}px -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", Arial, sans-serif`;
          textWidth = ctx.measureText(displayText).width;
        }
        
        // å¦‚æœç¼©å°åè¿˜æ˜¯å¤ªé•¿ï¼Œæˆªæ–­æ–‡å­—å¹¶åŠ çœç•¥å·
        if (textWidth > maxTextWidth) {
          while (textWidth > maxTextWidth && displayText.length > 1) {
            displayText = displayText.slice(0, -1);
            textWidth = ctx.measureText(displayText + "...").width;
          }
          displayText = displayText + "...";
        }
        
        ctx.fillText(displayText, textStartRadius, 0);
        ctx.restore();
      });
    }

    /* ========= åˆ‡æ¢è½¬ç›˜ ========= */
    function switchWheel(type) {
      if (spinning) return;

      currentType = type;
      currentItems = [...wheels[type].items];
      document.getElementById("title").innerText = wheels[type].title;

      document
        .getElementById("tab-milk")
        .classList.toggle("active", type === "milkTea");
      document
        .getElementById("tab-food")
        .classList.toggle("active", type === "food");

      resultEl.classList.remove("show");
      canvas.style.transform = "rotate(0deg)";
      currentAngle = 0;

      drawWheel();
    }

    /* ========= æ—‹è½¬ ========= */
    function spin() {
      if (spinning || currentItems.length === 0) return;
      spinning = true;
      resultEl.classList.remove("show");

      const count = currentItems.length;
      const stepDeg = 360 / count;
      // éšæœºæ—‹è½¬è§’åº¦ï¼ˆè‡³å°‘è½¬4åœˆï¼‰
      const extraRotate = Math.random() * 360 + 360 * 4;
      currentAngle += extraRotate;

      canvas.style.transform = `rotate(${currentAngle}deg)`;

      setTimeout(() => {
        // ä¿®å¤ï¼šè®¡ç®—æŒ‡é’ˆæŒ‡å‘çš„çœŸå®è§’åº¦
        // è½¬ç›˜ä»é¡¶éƒ¨ï¼ˆ-90åº¦ï¼‰å¼€å§‹ç»˜åˆ¶ï¼Œé¡ºæ—¶é’ˆæ—‹è½¬currentAngleåº¦
        // æŒ‡é’ˆå›ºå®šåœ¨é¡¶éƒ¨ï¼ˆ0åº¦ä½ç½®ï¼‰
        // è½¬ç›˜æ—‹è½¬åï¼Œéœ€è¦è®¡ç®—æŒ‡é’ˆæŒ‡å‘å“ªä¸ªæ‰‡å½¢
        const finalAngle = currentAngle % 360;
        // è½¬ç›˜æ—‹è½¬åï¼ŒåŸæœ¬åœ¨é¡¶éƒ¨çš„æ‰‡å½¢ç°åœ¨åœ¨ (360 - finalAngle) % 360 çš„ä½ç½®
        // ä½†ç¬¬ä¸€ä¸ªæ‰‡å½¢çš„ä¸­å¿ƒä¸åœ¨é¡¶éƒ¨ï¼Œè€Œæ˜¯åœ¨é¡¶éƒ¨å stepDeg/2 çš„ä½ç½®
        // æ‰€ä»¥éœ€è¦è°ƒæ•´è®¡ç®—
        const adjustedAngle = (360 - finalAngle + stepDeg / 2) % 360;
        let index = Math.floor(adjustedAngle / stepDeg);
        // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
        index = index % count;
        if (index < 0) index = (index + count) % count;
        
        const selected = currentItems[index];
        resultEl.innerText = `âœ¨ å°±æ˜¯å®ƒï¼š${selected.name}`;
        resultEl.classList.add("show");
        spinning = false;
      }, 3000);
    }

    /* ========= ç¼–è¾‘åŠŸèƒ½ ========= */
    function openEditModal() {
      if (spinning) return;
      const modal = document.getElementById("editModal");
      const content = document.getElementById("editContent");
      
      // åªå±•ç¤ºâ€œå·²åœ¨å½“å‰åˆ—è¡¨ä¸­å‡ºç°è¿‡çš„ç»„ï¼ˆå«ä¸­æ–‡åº—åï¼‰â€ï¼Œé¿å…è¯¯å¯¼åªèƒ½ç”¨è‹±æ–‡ group
      const allGroups = [...new Set(wheels[currentType].items.map(item => (item.group || "").trim()).filter(Boolean))];
      
      let html = '<button class="add-btn" onclick="addItem()">+ æ·»åŠ é¡¹ç›®</button>';
      html += '<div class="item-list">';
      
      wheels[currentType].items.forEach((item, index) => {
        html += `
          <div class="item-row">
            <input type="text" value="${item.name}" data-index="${index}" data-field="name" placeholder="åç§°">
            <input type="text" value="${item.group || ""}" data-index="${index}" data-field="group" placeholder="åº—å/åˆ†ç»„ï¼ˆæ”¯æŒä¸­æ–‡ï¼ŒåŒåº—åŒè‰²ï¼‰" list="groupList" onchange="updateGroupInput(this)">
            <button class="delete-btn" onclick="deleteItem(${index})">åˆ é™¤</button>
          </div>
        `;
      });
      
      html += '</div>';
      // å…±äº«ä¸€ä¸ª datalistï¼Œé¿å…é‡å¤æ¸²æŸ“
      html += `
        <datalist id="groupList">
          ${allGroups.map(g => `<option value="${g}">`).join("")}
        </datalist>
      `;
      content.innerHTML = html;
      
      // ç»‘å®šè¾“å…¥äº‹ä»¶
      content.querySelectorAll('input[data-field="name"]').forEach(el => {
        el.addEventListener('change', function() {
          const index = parseInt(this.dataset.index);
          wheels[currentType].items[index].name = this.value;
        });
      });
      
      modal.classList.add("show");
    }

    function updateGroupInput(inputEl) {
      const index = parseInt(inputEl.dataset.index);
      const value = inputEl.value.trim();
      if (value) {
        wheels[currentType].items[index].group = value;
        // ç¡®ä¿è¯¥ group æœ‰é¢œè‰²ï¼ˆä¼šè‡ªåŠ¨æŒä¹…åŒ–åˆ° localStorageï¼‰
        getGroupColor(value);
      } else {
        wheels[currentType].items[index].group = "";
      }
    }

    function closeEditModal() {
      document.getElementById("editModal").classList.remove("show");
    }

    function addItem() {
      wheels[currentType].items.push({ name: "æ–°é¡¹ç›®", group: "default" });
      openEditModal(); // é‡æ–°æ¸²æŸ“
    }

    function deleteItem(index) {
      wheels[currentType].items.splice(index, 1);
      openEditModal(); // é‡æ–°æ¸²æŸ“
    }

    function saveItems() {
      saveWheels();
      switchWheel(currentType); // é‡æ–°åŠ è½½å¹¶ç»˜åˆ¶
      closeEditModal();
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById("editModal").addEventListener("click", function(e) {
      if (e.target === this) {
        closeEditModal();
      }
    });

    /* ========= åˆå§‹åŒ– ========= */
    setupCanvas(); // è®¾ç½® Canvas é«˜ DPI æ”¯æŒ
    loadWheels();
    switchWheel("milkTea");
  </script>
</body>
</html>
